<%- include('../../partials/head') %>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white">
  <%- include('../../partials/Investor-nav') %>
<main class="Flexible">
  <div class="p-10 mt-10 space-y-12">




     <!-- ====================== STOCK TABLE ======================= -->
    <div class="bg-slate-800 p-8 rounded-2xl shadow-lg w-full">
      <h2 class="text-2xl font-bold mb-6 text-center">Stock List</h2>

      <table class="w-full text-left border-collapse">
        <thead>
          <tr class="bg-slate-700 text-sm">
            <th class="p-3">Registration Number</th>
            <th class="p-3">Stock ID</th>
            <th class="p-3">Total Shares</th>
            <th class="p-3">Current Price</th>
            <th class="p-3">Action</th>
          </tr>
        </thead>

        <tbody>
          <% StockList.forEach(stock => { %>
            <tr class="border-b border-slate-700 hover:bg-slate-700/40 transition">
              <td class="p-3"><%= stock.registrationNumber %></td>
              <td class="p-3"><%= stock.stockId %></td>
              <td class="p-3"><%= stock.totalShares %></td>
              <td class="p-3">$<%= stock.currentPrice %></td>

              <td class="p-3">
                <button class="bg-blue-600 hover:bg-blue-700 px-4 py-1 rounded text-sm buyBtn"
                        data-id="<%= stock.stockId %>">
                  Buy
                </button>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <!-- Success message placeholder (kept for legacy access) -->
      <p id="buyMessage" class="sr-only">Done</p>
    </div>

    <!-- ====================== COMPANY TABLE ======================= -->
    <div class="bg-slate-800 p-8 rounded-2xl shadow-lg w-full">
      <h2 class="text-2xl font-bold mb-6 text-center">Company Details</h2>

      <table class="w-full text-left border-collapse">
        <thead>
              <tr class="bg-slate-700 text-sm">
                <th class="p-3">Registration Number</th>
                <th class="p-3">Name</th>
                <th class="p-3">Sector</th>
                <th class="p-3">Contact Info</th>
              </tr>
        </thead>

        <tbody>
          <% CompanyList.forEach(company => { %>
            <tr class="border-b border-slate-700 hover:bg-slate-700/40 transition">
              <td class="p-3"><%= company.registrationNumber %></td>
              <td class="p-3"><%= company.name %></td>
              <td class="p-3"><%= company.sector %></td>
              <td class="p-3"><%= company.contactInfo %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>


   

  </div>
</main>
  <script>
    // BUY BUTTON HANDLER: show modal to input amount, then POST
    let selectedStockId = null;

    // create modal elements
    const modal = document.createElement('div');
    modal.id = 'buyModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden';
    modal.innerHTML = `
      <div class="bg-slate-800 p-6 rounded-lg w-96">
        <h3 class="text-lg font-semibold mb-2">Buy Stock</h3>
        <p id="modalStockId" class="text-sm text-gray-200 mb-3"></p>
        <label class="block text-sm mb-1">Amount</label>
        <input id="buyAmount" type="number" min="1" class="w-full p-2 rounded mb-4 text-black" />
        <div class="flex justify-end gap-2">
          <button id="cancelBuy" class="px-4 py-2 rounded bg-gray-600 hover:bg-gray-700">Cancel</button>
          <button id="confirmBuy" class="px-4 py-2 rounded bg-blue-600 hover:bg-blue-700">Confirm</button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    // Success popup (created once)
    const successPopup = document.createElement('div');
    successPopup.id = 'successPopup';
    successPopup.className = 'fixed inset-0 flex items-center justify-center pointer-events-none hidden';
    successPopup.innerHTML = `
      <div class="pointer-events-auto bg-white/5 backdrop-blur-sm border border-green-500 rounded-lg p-6 w-80 text-center text-white">
        <div class="flex flex-col items-center gap-3">
          <div class="w-16 h-16 flex items-center justify-center rounded-full bg-green-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="white">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <div id="successTitle" class="text-lg font-semibold">Congratulations!</div>
          <div id="successMsg" class="text-sm text-slate-200">Purchase successful.</div>
          <div id="successTxn" class="text-xs text-slate-300"></div>
        </div>
      </div>
    `;
    document.body.appendChild(successPopup);

    function showSuccessPopup(message, txnId) {
      const title = document.getElementById('successTitle');
      const msg = document.getElementById('successMsg');
      const txn = document.getElementById('successTxn');
      title.textContent = 'Congratulations!';
      msg.textContent = message || 'Purchase successful.';
      txn.textContent = txnId ? ('Transaction: ' + txnId) : '';
      successPopup.classList.remove('hidden');
      successPopup.classList.add('flex');
      // auto hide after 3.5s
      setTimeout(hideSuccessPopup, 3500);
    }

    function hideSuccessPopup() {
      successPopup.classList.add('hidden');
      successPopup.classList.remove('flex');
    }

    function showModal(stockId) {
      selectedStockId = stockId;
      document.getElementById('modalStockId').textContent = 'Stock ID: ' + stockId;
      document.getElementById('buyAmount').value = '';
      modal.classList.remove('hidden');
    }

    function hideModal() {
      selectedStockId = null;
      modal.classList.add('hidden');
    }

    document.querySelectorAll('.buyBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const stockId = btn.getAttribute('data-id');
        showModal(stockId);
      });
    });

    document.getElementById('cancelBuy').addEventListener('click', () => {
      hideModal();
    });

    document.getElementById('confirmBuy').addEventListener('click', async () => {
      const amountEl = document.getElementById('buyAmount');
      const amount = amountEl.value;

      if (!selectedStockId || !amount || Number(amount) <= 0) {
        alert('Please enter a valid amount');
        return;
      }

      try {
        const response = await fetch('/Investor/buy-stock', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ stockId: selectedStockId, amount })
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          alert('Buy failed: ' + (err.error || response.statusText));
        } else {
          const data = await response.json();
          // show nice success popup with transaction id if returned
          const txn = data.transactionId || data.transactionid || '';
          showSuccessPopup('Purchase submitted', txn);
        }
      } catch (e) {
        console.error(e);
        alert('Network error');
      } finally {
        hideModal();
      }
    });
  </script>

</body>
</html>
