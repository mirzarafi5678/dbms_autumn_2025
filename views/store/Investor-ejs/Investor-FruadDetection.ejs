<%- include('../../partials/head') %>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white">

<%- include('../../partials/Investor-nav') %>

<div class="container mx-auto py-10 px-4 space-y-10">

  <!-- 1ï¸âƒ£ Transaction Table -->
  <div class="bg-slate-800 p-6 rounded-2xl shadow-lg ml-20">
    <h2 class="text-2xl font-bold mb-4 text-center">Transactions</h2>
    <table class="w-full table-auto border-collapse border border-slate-600">
      <thead>
        <tr class="bg-slate-700">
          <th class="border border-slate-600 px-4 py-2">TID</th>
          <th class="border border-slate-600 px-4 py-2">Stock ID</th>
          <th class="border border-slate-600 px-4 py-2">Investor ID</th>
          <th class="border border-slate-600 px-4 py-2">Amount</th>
          <th class="border border-slate-600 px-4 py-2">Detect</th>
        </tr>
      </thead>
      <tbody>
        <% if (transactionList && transactionList.length > 0) { %>
          <% transactionList.forEach(tx => { %>
            <tr>
              <td class="border border-slate-600 px-4 py-2"><%= tx.tid %></td>
              <td class="border border-slate-600 px-4 py-2"><%= tx.stockId %></td>
              <td class="border border-slate-600 px-4 py-2"><%= tx.investorId %></td>
              <td class="border border-slate-600 px-4 py-2"><%= tx.amount %></td>
              <td class="border border-slate-600 px-4 py-2 text-center">
                <button class="detectBtn bg-red-600 hover:bg-red-700 px-3 py-1 rounded font-semibold text-sm"
                  data-tid="<%= tx.tid %>" data-stockid="<%= tx.stockId %>" data-investorid="<%= tx.investorId %>" data-amount="<%= tx.amount %>">
                  Detect
                </button>
              </td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

  <!-- 2ï¸âƒ£ Detection Section -->
<!-- 2ï¸âƒ£ Detection Section -->
<div class="bg-slate-800 p-6 rounded-2xl shadow-lg max-w-2xl mx-auto">
  <h2 class="text-2xl font-bold mb-4 text-center">Fraud Detection Result</h2>

  <!-- ðŸ‘‡ Add this loading indicator -->
  <div id="loading" class="text-center hidden">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-4 border-b-4 border-blue-500"></div>
    <p class="mt-2 text-sm text-blue-300">Analyzing transaction with AI...</p>
  </div>

  <div id="detectionResult" class="space-y-2 text-white">
    <p><strong>Risk Score:</strong> <span id="riskScore">-</span></p>
    <p><strong>Accuracy Score:</strong> <span id="accuracyScore">-</span></p>
    <p><strong>Detection Date:</strong> <span id="detectionDate">-</span></p>
    <p><strong>Summary:</strong> <span id="summary">-</span></p>
  </div>

  <button id="addFraudBtn" class="mt-4 w-full bg-blue-600 hover:bg-blue-700 py-2 rounded font-semibold transition">Add</button>
  <p id="successMsg" class="text-green-400 text-center mt-2 hidden">âœ… Added to Fraud Table!</p>
</div>

  <!-- 3ï¸âƒ£ Fraud Table -->
  <div class="bg-slate-800 p-6 rounded-2xl shadow-lg max-w-5xl mx-auto">
    <h2 class="text-2xl font-bold mb-4 text-center">Fraud Table</h2>
    <table class="w-full table-auto border-collapse border border-slate-600">
      <thead>
        <tr class="bg-slate-700">
          <th class="border border-slate-600 px-4 py-2">Alert ID</th>
          <th class="border border-slate-600 px-4 py-2">TID</th>
          <th class="border border-slate-600 px-4 py-2">Risk Score</th>
          <th class="border border-slate-600 px-4 py-2">Accuracy Score</th>
          <th class="border border-slate-600 px-4 py-2">Detection Date</th>
          <th class="border border-slate-600 px-4 py-2">Summary</th>
        </tr>
      </thead>
      <tbody id="fraudTableBody">
        <% if (fraudList && fraudList.length > 0) { %>
          <% fraudList.forEach(f => { %>
            <tr>
              <td class="border border-slate-600 px-4 py-2"><%= f.alertId %></td>
              <td class="border border-slate-600 px-4 py-2"><%= f.tid %></td>
              <td class="border border-slate-600 px-4 py-2"><%= f.riskScore %></td>
              <td class="border border-slate-600 px-4 py-2"><%= f.accuracyScore %></td>
              <td class="border border-slate-600 px-4 py-2"><%= f.detectionDate %></td>
              <td class="border border-slate-600 px-4 py-2"><%= f.summary %></td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>

</div>

<script>
  const detectButtons = document.querySelectorAll('.detectBtn');
  let currentDetection = {};

  // Create a simple loading spinner dynamically
  const loader = document.createElement('div');
  loader.id = 'aiLoader';
  loader.className = 'hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50';
  loader.innerHTML = `
    <div class="bg-slate-800 p-6 rounded-2xl text-center">
      <div class="inline-block animate-spin rounded-full h-10 w-10 border-t-4 border-b-4 border-blue-500 mb-3"></div>
      <p class="text-blue-300 font-medium">Analyzing transaction with AI...</p>
    </div>
  `;
  document.body.appendChild(loader);

  // Helper functions to show/hide the loader
  const showLoader = () => loader.classList.remove('hidden');
  const hideLoader = () => loader.classList.add('hidden');

  detectButtons.forEach(btn => {
    btn.addEventListener('click', async () => {
      const tid = btn.dataset.tid;
      const stockId = btn.dataset.stockid;
      const investorId = btn.dataset.investorid;
      const amount = btn.dataset.amount;

      showLoader(); // ðŸ‘ˆ Show spinner before API call

      try {
        const response = await fetch('/investor/ai-detect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tid, stockId, investorId, amount })
        });

        const result = await response.json();

        document.getElementById('riskScore').textContent = result.riskScore;
        document.getElementById('accuracyScore').textContent = result.accuracyScore;
        document.getElementById('detectionDate').textContent = result.detectionDate;
        document.getElementById('summary').textContent = result.summary;

        currentDetection = { tid, ...result };
      } catch (err) {
        console.error('Detection failed', err);
        alert('AI detection failed. Please try again.');
      } finally {
        hideLoader(); // ðŸ‘ˆ Always hide spinner after API call (success or fail)
      }
    });
  });

  document.getElementById('addFraudBtn').addEventListener('click', async () => {
    if (!currentDetection.tid) return;

    try {
      const res = await fetch('/investor/add-fraud', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(currentDetection)
      });

      if (res.ok) {
        const saved = await res.json();

        const tbody = document.getElementById('fraudTableBody');
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="border border-slate-600 px-4 py-2">${saved.alertId}</td>
          <td class="border border-slate-600 px-4 py-2">${saved.tid}</td>
          <td class="border border-slate-600 px-4 py-2">${saved.riskScore}</td>
          <td class="border border-slate-600 px-4 py-2">${saved.accuracyScore}</td>
          <td class="border border-slate-600 px-4 py-2">${saved.detectionDate}</td>
          <td class="border border-slate-600 px-4 py-2">${saved.summary}</td>
        `;
        tbody.appendChild(row);

        const msg = document.getElementById('successMsg');
        msg.classList.remove('hidden');
        setTimeout(() => msg.classList.add('hidden'), 2000);

        currentDetection = {};
      }
    } catch (err) {
      console.error('Failed to add fraud detection', err);
    }
  });
</script>


</body>
</html>
