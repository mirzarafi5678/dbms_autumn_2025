<%- include('../../partials/head') %>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white">
  <%- include('../../partials/admin-nav') %>

  <div class="container mx-auto p-6 space-y-16">
    <!-- ================= STOCK TRANSACTIONS ================= -->
    <section>
      <h1 class="text-3xl font-bold mb-6 text-center">Stock Transactions Management</h1>

      <!-- Search + Add -->
      <div class="flex justify-between mb-4">
        <form method="GET" action="/Admin/transactions/search" class="flex gap-2">
          <input type="text" name="query" placeholder="Search by Transaction ID..." 
                 class="px-3 py-2 rounded-lg text-black" />
          <button type="submit" class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700">Search</button>
        </form>
         <a href="/Admin/Stock-Transaction" 
   class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700">
               Show ALL
         </a>

        <button onclick="openAddTxModal()" class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700">
          Add Transaction
        </button>
      </div>

      <!-- Transactions Table -->
      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-700 rounded-lg">
          <thead class="bg-blue-800 text-white">
            <tr>
              <th class="px-4 py-2 border">Transaction ID</th>
              <th class="px-4 py-2 border">Timestamp</th>
              <th class="px-4 py-2 border">Stock ID</th>
              <th class="px-4 py-2 border">Investor ID</th>
              <th class="px-4 py-2 border">Amount</th>
              <th class="px-4 py-2 border">Registration #</th>
              <th class="px-4 py-2 border">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (TransactionList && TransactionList.length > 0) { %>
              <% TransactionList.forEach(function(tx) { %>
                <tr class="border-b border-slate-700 hover:bg-slate-700">
                  <td class="py-2 px-4"><%= tx.transactionId %></td>
                  <td class="py-2 px-4"><%= tx.timestamp %></td>
                  <td class="py-2 px-4"><%= tx.stockId %></td>
                  <td class="py-2 px-4"><%= tx.iUserId %></td>
                  <td class="py-2 px-4"><%= tx.amount %></td>
                  <td class="py-2 px-4"><%= tx.registrationNumber %></td>
                  <td class="py-2 px-4 flex gap-2">
                    <button onclick='openEditTxModal(<%= JSON.stringify(tx) %>)'
                            class="bg-yellow-500 px-3 py-1 rounded-lg hover:bg-yellow-600">
                      Edit
                    </button>
                    <form action="/Admin/transactions/delete/<%= tx.transactionId %>" method="POST">
                      <button type="submit" class="bg-red-600 px-3 py-1 rounded-lg hover:bg-red-700">
                        Delete
                      </button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr><td colspan="5" class="text-center py-4">No transactions found</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </section>

    <!-- ================= INVESTORS ================= -->
    <section>
      <h1 class="text-3xl font-bold mb-6 text-center">Investor Management</h1>

      <!-- Search + Add -->
      <div class="flex justify-between mb-4">
        <form method="GET" action="/Admin/investors/search" class="flex gap-2">
          <input type="text" name="query" placeholder="Search by Investor ID..." 
                 class="px-3 py-2 rounded-lg text-black" />
          <button type="submit" class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700">Search</button>
        </form>
       <a href="/Admin/Stock-Transaction" 
   class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700">
               Show ALL
         </a>
        <button onclick="openAddInvestorModal()" class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700">
          Add Investor
        </button>
      </div>

      <!-- Investors Table -->
      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-700 rounded-lg">
          <thead class="bg-blue-800 text-white">
            <tr>
              <th class="px-4 py-2 border">Investor ID</th>
              <th class="px-4 py-2 border">Name</th>
              <th class="px-4 py-2 border">Account Type</th>
              <th class="px-4 py-2 border">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (InvestorList && InvestorList.length > 0) { %>
              <% InvestorList.forEach(function(investor) { %>
                <tr class="border-b border-slate-700 hover:bg-slate-700">
                  <td class="py-2 px-4"><%= investor.iUserId %></td>
                  <td class="py-2 px-4"><%= investor.name %></td>
                  <td class="py-2 px-4"><%= investor.accountType %></td>
                  <td class="py-2 px-4 flex gap-2">
                    <button onclick='openEditInvestorModal(<%= JSON.stringify(investor) %>)'
                            class="bg-yellow-500 px-3 py-1 rounded-lg hover:bg-yellow-600">
                      Edit
                    </button>
                    <form action="/Admin/investors/delete/<%= investor.iUserId %>" method="POST">
                      <button type="submit" class="bg-red-600 px-3 py-1 rounded-lg hover:bg-red-700">
                        Delete
                      </button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr><td colspan="4" class="text-center py-4">No investors found</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </section>

    

  <!-- ================= TRANSACTION MODALS ================= -->
  <div id="addTxModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-slate-800 p-6 rounded-lg w-96">
      <h2 class="text-xl mb-4">Add Transaction</h2>
      <form method="POST" action="/Admin/transactions/add">
        <input type="text" name="transactionId" placeholder="Transaction ID" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="datetime-local" name="timestamp" placeholder="Timestamp" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="stockId" placeholder="Stock ID" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="iUserId" placeholder="Investor ID" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="number" step="0.01" name="amount" placeholder="Amount" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="registrationNumber" placeholder="Company Registration Number" class="w-full p-2 mb-3 rounded text-black">
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeAddTxModal()" class="bg-gray-600 px-3 py-1 rounded-lg hover:bg-gray-700">Cancel</button>
          <button type="submit" class="bg-green-600 px-3 py-1 rounded-lg hover:bg-green-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="editTxModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-slate-800 p-6 rounded-lg w-96">
      <h2 class="text-xl mb-4">Edit Transaction</h2>
      <form id="editTxForm" method="POST">
        <input type="text" name="transactionId" id="editTransactionId" class="w-full p-2 mb-3 rounded text-black" readonly>
        <input type="datetime-local" name="timestamp" id="editTimestampTx" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="stockId" id="editStockIdTx" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="iUserId" id="editIUserIdTx" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="number" step="0.01" name="amount" id="editAmountTx" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="registrationNumber" id="editRegistrationNumberTx" class="w-full p-2 mb-3 rounded text-black">
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeEditTxModal()" class="bg-gray-600 px-3 py-1 rounded-lg hover:bg-gray-700">Cancel</button>
          <button type="submit" class="bg-yellow-500 px-3 py-1 rounded-lg hover:bg-yellow-600">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ================= INVESTOR MODALS ================= -->
  <div id="addInvestorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-slate-800 p-6 rounded-lg w-96">
      <h2 class="text-xl mb-4">Add Investor</h2>
      <form method="POST" action="/Admin/investors/add">
        <input type="text" name="iUserId" placeholder="Investor ID" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="name" placeholder="Name" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="accountType" placeholder="Account Type" class="w-full p-2 mb-3 rounded text-black" required>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeAddInvestorModal()" class="bg-gray-600 px-3 py-1 rounded-lg hover:bg-gray-700">Cancel</button>
          <button type="submit" class="bg-green-600 px-3 py-1 rounded-lg hover:bg-green-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="editInvestorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-slate-800 p-6 rounded-lg w-96">
      <h2 class="text-xl mb-4">Edit Investor</h2>
      <form id="editInvestorForm" method="POST">
        <input type="text" name="iUserId" id="editIUserId" class="w-full p-2 mb-3 rounded text-black" readonly>
        <input type="text" name="name" id="editInvestorName" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="accountType" id="editInvestorAccountType" class="w-full p-2 mb-3 rounded text-black" required>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeEditInvestorModal()" class="bg-gray-600 px-3 py-1 rounded-lg hover:bg-gray-700">Cancel</button>
          <button type="submit" class="bg-yellow-500 px-3 py-1 rounded-lg hover:bg-yellow-600">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ================= SCRIPTS ================= -->
  <script>
    // Small helpers
    function _id(id){ return document.getElementById(id); }
    function toLocalDatetimeValue(ts){
      if (!ts && ts !== 0) return '';
      try {
        var d = (typeof ts === 'number') ? new Date(ts) : new Date(ts);
        if (isNaN(d)) return '';
        return d.toISOString().slice(0,16);
      } catch (e) { return ''; }
    }

    // Transaction modals
    function openAddTxModal(){ var el=_id('addTxModal'); if(el) el.classList.remove('hidden'); }
    function closeAddTxModal(){ var el=_id('addTxModal'); if(el) el.classList.add('hidden'); }
    function openEditTxModal(tx){
      try{
        if(!_id('editTxModal')) return;
        if(_id('editTransactionId')) _id('editTransactionId').value = tx.transactionId || '';
        if(_id('editTimestampTx')) _id('editTimestampTx').value = toLocalDatetimeValue(tx.timestamp);
        if(_id('editStockIdTx')) _id('editStockIdTx').value = tx.stockId || '';
        if(_id('editIUserIdTx')) _id('editIUserIdTx').value = tx.iUserId || '';
        if(_id('editAmountTx')) _id('editAmountTx').value = tx.amount || '';
        if(_id('editRegistrationNumberTx')) _id('editRegistrationNumberTx').value = tx.registrationNumber || '';
        var f = _id('editTxForm'); if(f && tx.transactionId) f.action = '/Admin/transactions/edit/' + encodeURIComponent(tx.transactionId);
        _id('editTxModal').classList.remove('hidden');
      }catch(e){ console.error('openEditTxModal error', e); }
    }
    function closeEditTxModal(){ var el=_id('editTxModal'); if(el) el.classList.add('hidden'); }

    // Investor modals
    function openAddInvestorModal(){ var el=_id('addInvestorModal'); if(el) el.classList.remove('hidden'); }
    function closeAddInvestorModal(){ var el=_id('addInvestorModal'); if(el) el.classList.add('hidden'); }
    function openEditInvestorModal(investor){
      try{
        if(!_id('editInvestorModal')) return;
        if(_id('editIUserId')) _id('editIUserId').value = investor.iUserId || '';
        if(_id('editInvestorName')) _id('editInvestorName').value = investor.name || '';
        if(_id('editInvestorAccountType')) _id('editInvestorAccountType').value = investor.accountType || '';
        var f = _id('editInvestorForm'); if(f && investor.iUserId) f.action = '/Admin/investors/edit/' + encodeURIComponent(investor.iUserId);
        _id('editInvestorModal').classList.remove('hidden');
      }catch(e){ console.error('openEditInvestorModal error', e); }
    }
    function closeEditInvestorModal(){ var el=_id('editInvestorModal'); if(el) el.classList.add('hidden'); }
  </script>
</body>
</html>