<%- include('../../partials/head') %>
</head>

<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white">
  <%- include('../../partials/admin-nav') %>

  <!-- Main Content -->
  <main class="min-h-screen pt-20 px-6 pb-10">
    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-4xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
          Admin Dashboard
        </h1>
        <p class="text-gray-400 mt-2">Real-time analytics and market insights</p>
      </div>

      <!-- Stats Cards -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 shadow-xl">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-blue-100 text-sm font-medium">Total Transactions</p>
              <p class="text-3xl font-bold mt-2"><%= tradingVolume.length %></p>
            </div>
            <div class="bg-white/20 p-3 rounded-xl">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 shadow-xl">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-purple-100 text-sm font-medium">Active Companies</p>
              <p class="text-3xl font-bold mt-2"><%= topCompanies.length %></p>
            </div>
            <div class="bg-white/20 p-3 rounded-xl">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-br from-pink-500 to-rose-600 rounded-2xl p-6 shadow-xl">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-pink-100 text-sm font-medium">Fraud Alerts</p>
              <p class="text-3xl font-bold mt-2"><%= fraudTrends.length %></p>
            </div>
            <div class="bg-white/20 p-3 rounded-xl">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-6 shadow-xl">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-green-100 text-sm font-medium">Trade Status</p>
              <p class="text-3xl font-bold mt-2"><%= tradeStatus.length %></p>
            </div>
            <div class="bg-white/20 p-3 rounded-xl">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Chart 1: Fraud Risk Trends -->
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-white/20">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold">Fraud Risk Trends</h2>
            <span class="px-3 py-1 bg-red-500/20 text-red-300 rounded-full text-sm">High Priority</span>
          </div>
          <div class="h-80">
            <canvas id="fraudChart"></canvas>
          </div>
        </div>

        <!-- Chart 2: Top Companies by Market Cap -->
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-white/20">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold">Top Companies by Market Cap</h2>
            <span class="px-3 py-1 bg-blue-500/20 text-blue-300 rounded-full text-sm">Market Leaders</span>
          </div>
          <div class="h-80">
            <canvas id="companiesChart"></canvas>
          </div>
        </div>

        <!-- Chart 3: Trading Volume Over Time -->
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-white/20">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold">Trading Volume Trends</h2>
            <span class="px-3 py-1 bg-green-500/20 text-green-300 rounded-full text-sm">Active</span>
          </div>
          <div class="h-80">
            <canvas id="volumeChart"></canvas>
          </div>
        </div>

        <!-- Chart 4: Trade Status Distribution -->
        <div class="bg-white/10 backdrop-blur-lg rounded-2xl p-6 shadow-2xl border border-white/20">
          <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold">Trade Status Distribution</h2>
            <span class="px-3 py-1 bg-purple-500/20 text-purple-300 rounded-full text-sm">Overview</span>
          </div>
          <div class="h-80">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Chart.js Global Configuration
    Chart.defaults.color = '#e5e7eb';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

    // Data from backend
    const fraudData = <%- JSON.stringify(fraudTrends) %>;
    const companiesData = <%- JSON.stringify(topCompanies) %>;
    const volumeData = <%- JSON.stringify(tradingVolume) %>;
    const statusData = <%- JSON.stringify(tradeStatus) %>;

    // 1. Fraud Risk Trends Chart (Line + Area)
    const fraudCtx = document.getElementById('fraudChart').getContext('2d');
    new Chart(fraudCtx, {
      type: 'line',
      data: {
        labels: fraudData.map(d => d.date),
        datasets: [{
          label: 'Average Risk Score',
          data: fraudData.map(d => d.avgRisk),
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239, 68, 68, 0.2)',
          fill: true,
          tension: 0.4,
          pointRadius: 5,
          pointHoverRadius: 7,
          pointBackgroundColor: '#ef4444',
          pointBorderColor: '#fff',
          pointBorderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            titleColor: '#fff',
            bodyColor: '#fff',
            borderColor: '#ef4444',
            borderWidth: 1
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: { color: 'rgba(255, 255, 255, 0.1)' },
            ticks: { callback: value => value.toFixed(1) }
          },
          x: {
            grid: { color: 'rgba(255, 255, 255, 0.1)' }
          }
        }
      }
    });

    // 2. Top Companies Chart (Horizontal Bar)
    const companiesCtx = document.getElementById('companiesChart').getContext('2d');
    new Chart(companiesCtx, {
      type: 'bar',
      data: {
        labels: companiesData.map(c => c.name),
        datasets: [{
          label: 'Market Cap (BDT)',
          data: companiesData.map(c => c.marketCap),
          backgroundColor: [
            '#3b82f6', '#8b5cf6', '#ec4899', '#10b981', 
            '#f59e0b', '#06b6d4', '#6366f1', '#14b8a6',
            '#f97316', '#84cc16'
          ],
          borderRadius: 8,
          borderWidth: 0
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            callbacks: {
              label: context => `Market Cap: ৳${context.parsed.x.toLocaleString()}`
            }
          }
        },
        scales: {
          x: {
            grid: { color: 'rgba(255, 255, 255, 0.1)' },
            ticks: { callback: value => `৳${(value/1000).toFixed(0)}K` }
          },
          y: {
            grid: { display: false }
          }
        }
      }
    });

    // 3. Trading Volume Chart (Area + Line)
    const volumeCtx = document.getElementById('volumeChart').getContext('2d');
    new Chart(volumeCtx, {
      type: 'line',
      data: {
        labels: volumeData.map(v => v.date),
        datasets: [
          {
            label: 'Transaction Count',
            data: volumeData.map(v => v.transactionCount),
            borderColor: '#10b981',
            backgroundColor: 'rgba(16, 185, 129, 0.2)',
            fill: true,
            tension: 0.4,
            yAxisID: 'y'
          },
          {
            label: 'Total Volume (BDT)',
            data: volumeData.map(v => v.totalVolume),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4,
            yAxisID: 'y1'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { display: true, position: 'top' },
          tooltip: { backgroundColor: 'rgba(0, 0, 0, 0.8)', padding: 12 }
        },
        scales: {
          y: {
            type: 'linear',
            position: 'left',
            grid: { color: 'rgba(255, 255, 255, 0.1)' },
            title: { display: true, text: 'Transaction Count' }
          },
          y1: {
            type: 'linear',
            position: 'right',
            grid: { display: false },
            title: { display: true, text: 'Volume (BDT)' }
          },
          x: {
            grid: { color: 'rgba(255, 255, 255, 0.1)' }
          }
        }
      }
    });

    // 4. Trade Status Chart (Doughnut)
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    new Chart(statusCtx, {
      type: 'doughnut',
      data: {
        labels: statusData.map(s => s.status),
        datasets: [{
          data: statusData.map(s => s.count),
          backgroundColor: [
            '#10b981', // Completed - Green
            '#f59e0b', // Pending - Yellow
            '#ef4444'  // Failed - Red
          ],
          borderWidth: 0,
          hoverOffset: 15
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              padding: 20,
              font: { size: 14 },
              usePointStyle: true,
              pointStyle: 'circle'
            }
          },
          tooltip: {
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            callbacks: {
              label: context => {
                const label = context.label || '';
                const value = context.parsed;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return `${label}: ${value} (${percentage}%)`;
              }
            }
          }
        },
        cutout: '70%'
      }
    });
  </script>
</body>
</html>