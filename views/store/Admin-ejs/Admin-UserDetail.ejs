<%- include('../../partials/head') %>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white">
  <%- include('../../partials/admin-nav') %>
  

  <div class="container mx-auto px-4 py-8">
    <!-- Investor Table -->
    <div class="mb-12">
      <h2 class="text-2xl font-bold mb-4">Investor</h2>
      <div class="mb-4 flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <input type="text" placeholder="Search Investor..." class="w-64 px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-blue-500" id="investorSearch">
          <button id="investorSearchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35" />
            </svg>
            Search
          </button>
        </div>

        <div>
          <button id="openInvestorAdd" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-200">
            + Add Investor
          </button>
        </div>
      </div>
      <div class="overflow-x-auto rounded-lg shadow">
        <table class="min-w-full bg-slate-800">
          <thead>
            <tr class="bg-blue-900 text-white">
              <th class="py-3 px-4 text-left">ID</th>
              <th class="py-3 px-4 text-left">Name</th>
              <th class="py-3 px-4 text-left">Contact</th>
              <th class="py-3 px-4 text-left">Action</th>
            </tr>
          </thead>
          <tbody id="investorTableBody">
            <% InvestorList.forEach(function(investor) { %>
              <tr class="border-b border-slate-700 hover:bg-slate-700">
                <td class="py-2 px-4"><%= investor.id %></td>
                <td class="py-2 px-4"><%= investor.name %></td>
                <td class="py-2 px-4"><%= investor.contact %></td>
                <td class="py-2 px-4">
                  <button class="edit-investor bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mr-2"
                          data-id="<%= investor.id %>" data-name="<%= investor.name %>" data-contact="<%= investor.contact %>">
                    Edit
                  </button>
                  <button class="delete-investor bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Delete</button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Stocks Transactions Table -->
    <div>
      <h2 class="text-2xl font-bold mb-4">Stocks Transactions</h2>
      <div class="mb-4 flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <input type="text" placeholder="Search Transactions..." class="w-64 px-4 py-2 rounded-lg text-black focus:outline-none focus:ring-2 focus:ring-blue-500" id="transactionSearch">
          <button id="transactionSearchBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center">
            <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-4.35-4.35" />
            </svg>
            Search
          </button>
        </div>

        <div>
          <button id="openTransactionAdd" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition-all duration-200">
            + Add Transaction
          </button>
        </div>
      </div>
      <div class="overflow-x-auto rounded-lg shadow">
        <table class="min-w-full bg-slate-800">
          <thead>
            <tr class="bg-blue-900 text-white">
              <th class="py-3 px-4 text-left">Tid</th>
              <th class="py-3 px-4 text-left">Stock ID</th>
              <th class="py-3 px-4 text-left">Investor ID</th>
              <th class="py-3 px-4 text-left">Amount</th>
              <th class="py-3 px-4 text-left">Action</th>
            </tr>
          </thead>
          <tbody id="transactionTableBody">
            <% TransactionList.forEach(function(tx) { %>
              <tr class="border-b border-slate-700 hover:bg-slate-700">
                <td class="py-2 px-4"><%= tx.tid %></td>
                <td class="py-2 px-4"><%= tx.stockId %></td>
                <td class="py-2 px-4"><%= tx.investorId %></td>
                <td class="py-2 px-4"><%= tx.amount %></td>
                <td class="py-2 px-4">
                  <button class="edit-transaction bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mr-2"
                          data-tid="<%= tx.tid %>" data-stockid="<%= tx.stockId %>" data-investorid="<%= tx.investorId %>" data-amount="<%= tx.amount %>">
                    Edit
                  </button>
                  <button class="delete-transaction bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Delete</button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Investor Add Modal -->
  <div id="investorModal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/50" data-close-target="investorModal"></div>
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 z-10 overflow-hidden">
      <div class="flex justify-between items-center px-4 py-3 border-b">
        <h3 class="text-lg font-semibold text-slate-900">Add Investor</h3>
        <button class="text-slate-600 hover:text-slate-900" data-close-target="investorModal">✕</button>
      </div>
      <form id="investorForm" action="/investor/add" method="POST" class="px-4 py-4 space-y-3">
        <div>
          <label class="text-sm text-slate-700">ID</label>
          <input name="id" required class="w-full px-3 py-2 rounded border" />
        </div>
        <div>
          <label class="text-sm text-slate-700">Name</label>
          <input name="name" required class="w-full px-3 py-2 rounded border" />
        </div>
        <div>
          <label class="text-sm text-slate-700">Contact</label>
          <input name="contact" class="w-full px-3 py-2 rounded border" />
        </div>
        <div class="pt-2 flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 rounded border" data-close-target="investorModal">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Investor Edit Modal -->
  <div id="investorEditModal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/50" data-close-target="investorEditModal"></div>
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 z-10 overflow-hidden">
      <div class="flex justify-between items-center px-4 py-3 border-b">
        <h3 class="text-lg font-semibold text-slate-900">Edit Investor</h3>
        <button class="text-slate-600 hover:text-slate-900" data-close-target="investorEditModal">✕</button>
      </div>
      <form id="investorEditForm" action="/investor/edit" method="POST" class="px-4 py-4 space-y-3">
        <input type="hidden" name="originalId" />
        <div>
          <label class="text-sm text-slate-700">ID</label>
          <input name="id" required class="w-full px-3 py-2 rounded border" />
        </div>
        <div>
          <label class="text-sm text-slate-700">Name</label>
          <input name="name" required class="w-full px-3 py-2 rounded border" />
        </div>
        <div>
          <label class="text-sm text-slate-700">Contact</label>
          <input name="contact" class="w-full px-3 py-2 rounded border" />
        </div>
        <div class="pt-2 flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 rounded border" data-close-target="investorEditModal">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Transaction Add Modal -->
  <div id="transactionModal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/50" data-close-target="transactionModal"></div>
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 z-10 overflow-hidden">
      <div class="flex justify-between items-center px-4 py-3 border-b">
        <h3 class="text-lg font-semibold text-slate-900">Add Transaction</h3>
        <button class="text-slate-600 hover:text-slate-900" data-close-target="transactionModal">✕</button>
      </div>
      <form id="transactionForm" action="/transaction/add" method="POST" class="px-4 py-4 space-y-3">
        <div>
          <label class="text-sm text-slate-700">Tid</label>
          <input name="tid" required class="w-full px-3 py-2 rounded border" />
        </div>
        <div>
          <label class="text-sm text-slate-700">Stock ID</label>
          <input name="stockId" required class="w-full px-3 py-2 rounded border" />
        </div>
        <div>
          <label class="text-sm text-slate-700">Investor ID</label>
          <input name="investorId" required class="w-full px-3 py-2 rounded border" />
        </div>
        <div>
          <label class="text-sm text-slate-700">Amount</label>
          <input name="amount" type="number" step="0.01" required class="w-full px-3 py-2 rounded border" />
        </div>
        <div class="pt-2 flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 rounded border" data-close-target="transactionModal">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Submit</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Transaction Edit Modal -->
  <div id="transactionEditModal" class="fixed inset-0 z-50 hidden items-center justify-center">
    <div class="absolute inset-0 bg-black/50" data-close-target="transactionEditModal"></div>
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 z-10 overflow-hidden">
      <div class="flex justify-between items-center px-4 py-3 border-b">
        <h3 class="text-lg font-semibold text-slate-900">Edit Transaction</h3>
        <button class="text-slate-600 hover:text-slate-900" data-close-target="transactionEditModal">✕</button>
      </div>
      <form id="transactionEditForm" action="/transaction/edit" method="POST" class="px-4 py-4 space-y-3">
        <input type="hidden" name="originalTid" />
        <div>
          <label class="text-sm text-slate-700">Tid</label>
          <input name="tid" required class="w-full px-3 py-2 rounded border" />
        </div>
        <div>
          <label class="text-sm text-slate-700">Stock ID</label>
          <input name="stockId" required class="w-full px-3 py-2 rounded border" />
        </div>
        <div>
          <label class="text-sm text-slate-700">Investor ID</label>
          <input name="investorId" required class="w-full px-3 py-2 rounded border" />
        </div>
        <div>
          <label class="text-sm text-slate-700">Amount</label>
          <input name="amount" type="number" step="0.01" required class="w-full px-3 py-2 rounded border" />
        </div>
        <div class="pt-2 flex justify-end space-x-2">
          <button type="button" class="px-4 py-2 rounded border" data-close-target="transactionEditModal">Cancel</button>
          <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Modal open/close handlers
    function openModal(id) {
      const modal = document.getElementById(id);
      if (!modal) return;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    function closeModal(id) {
      const modal = document.getElementById(id);
      if (!modal) return;
      modal.classList.remove('flex');
      modal.classList.add('hidden');
    }

    document.getElementById('openInvestorAdd')?.addEventListener('click', () => openModal('investorModal'));
    document.getElementById('openTransactionAdd')?.addEventListener('click', () => openModal('transactionModal'));

    // Close when clicking overlay or buttons with data-close-target
    document.querySelectorAll('[data-close-target]').forEach(el => {
      el.addEventListener('click', (e) => {
        const target = e.currentTarget.getAttribute('data-close-target');
        if (target) closeModal(target);
        else {
          const parent = e.currentTarget.closest('.fixed');
          if (parent && parent.id) closeModal(parent.id);
        }
      });
    });

    // Close on Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeModal('investorModal');
        closeModal('transactionModal');
        closeModal('investorEditModal');
        closeModal('transactionEditModal');
      }
    });

    // Submit handlers - try AJAX then fallback to default submit
    async function handleFormSubmit(e, tableBodyId, fields) {
      e.preventDefault();
      const form = e.target;
      const action = form.action || window.location.href;
      const formData = new FormData(form);
      try {
        const resp = await fetch(action, { method: 'POST', body: formData, credentials: 'same-origin' });
        if (resp.ok) {
          let data;
          try { data = await resp.json(); } catch (err) { data = null; }
          const values = data || Object.fromEntries(formData.entries());
          appendRow(tableBodyId, fields, values);
          const modalId = form.id === 'investorForm' ? 'investorModal' : 'transactionModal';
          closeModal(modalId);
          form.reset();
        } else {
          form.submit();
        }
      } catch (err) {
        form.submit();
      }
    }

    function appendRow(tableBodyId, fields, values) {
      const tbody = document.getElementById(tableBodyId);
      if (!tbody) return;
      const tr = document.createElement('tr');
      tr.className = 'border-b border-slate-700 hover:bg-slate-700 text-white';
      fields.forEach(f => {
        const td = document.createElement('td');
        td.className = 'py-2 px-4';
        td.textContent = values[f] ?? '';
        tr.appendChild(td);
      });
      const actionTd = document.createElement('td');
      actionTd.className = 'py-2 px-4';
      if (tableBodyId === 'investorTableBody') {
        const id = values['id'] ?? '';
        const name = values['name'] ?? '';
        const contact = values['contact'] ?? '';
        actionTd.innerHTML = `
          <button class="edit-investor bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mr-2" data-id="${id}" data-name="${name}" data-contact="${contact}">Edit</button>
          <button class="delete-investor bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Delete</button>
        `;
      } else if (tableBodyId === 'transactionTableBody') {
        const tid = values['tid'] ?? '';
        const stockId = values['stockId'] ?? '';
        const investorId = values['investorId'] ?? '';
        const amount = values['amount'] ?? '';
        actionTd.innerHTML = `
          <button class="edit-transaction bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mr-2" data-tid="${tid}" data-stockid="${stockId}" data-investorid="${investorId}" data-amount="${amount}">Edit</button>
          <button class="delete-transaction bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Delete</button>
        `;
      } else {
        actionTd.innerHTML = `
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mr-2">Edit</button>
          <button class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded">Delete</button>
        `;
      }
      tr.appendChild(actionTd);
      tbody.appendChild(tr);
    }

    document.getElementById('investorForm')?.addEventListener('submit', (e) => handleFormSubmit(e, 'investorTableBody', ['id','name','contact']));
    document.getElementById('transactionForm')?.addEventListener('submit', (e) => handleFormSubmit(e, 'transactionTableBody', ['tid','stockId','investorId','amount']));

    // Edit modal handlers: delegation
    document.getElementById('investorTableBody')?.addEventListener('click', (e) => {
      const btn = e.target.closest('.edit-investor');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const name = btn.getAttribute('data-name');
      const contact = btn.getAttribute('data-contact');
      const form = document.getElementById('investorEditForm');
      form.originalId.value = id;
      form.id.value = id;
      form.name.value = name;
      form.contact.value = contact;
      openModal('investorEditModal');
    });

    document.getElementById('transactionTableBody')?.addEventListener('click', (e) => {
      const btn = e.target.closest('.edit-transaction');
      if (!btn) return;
      const tid = btn.getAttribute('data-tid');
      const stockId = btn.getAttribute('data-stockid');
      const investorId = btn.getAttribute('data-investorid');
      const amount = btn.getAttribute('data-amount');
      const form = document.getElementById('transactionEditForm');
      form.originalTid.value = tid;
      form.tid.value = tid;
      form.stockId.value = stockId;
      form.investorId.value = investorId;
      form.amount.value = amount;
      openModal('transactionEditModal');
    });

    // Edit form submit - updates existing row
    async function handleEditSubmit(e, tableBodyId, idField, fields) {
      e.preventDefault();
      const form = e.target;
      const action = form.action || window.location.href;
      const formData = new FormData(form);
      try {
        const resp = await fetch(action, { method: 'POST', body: formData, credentials: 'same-origin' });
        if (resp.ok) {
          let data;
          try { data = await resp.json(); } catch (err) { data = null; }
          const values = data || Object.fromEntries(formData.entries());
          const originalId = formData.get(idField === 'id' ? 'originalId' : 'originalTid');
          updateRow(tableBodyId, idField, originalId, values, fields);
          const modalId = form.id === 'investorEditForm' ? 'investorEditModal' : 'transactionEditModal';
          closeModal(modalId);
          form.reset();
        } else {
          form.submit();
        }
      } catch (err) {
        form.submit();
      }
    }

    function updateRow(tableBodyId, idField, originalId, values, fields) {
      const tbody = document.getElementById(tableBodyId);
      if (!tbody) return;
      const rows = Array.from(tbody.querySelectorAll('tr'));
      for (const row of rows) {
        const firstCell = row.querySelector('td');
        if (!firstCell) continue;
        if (String(firstCell.textContent).trim() === String(originalId).trim()) {
          const tds = row.querySelectorAll('td');
          fields.forEach((f, idx) => {
            if (tds[idx]) tds[idx].textContent = values[f] ?? '';
          });
          const editBtn = row.querySelector(idField === 'id' ? '.edit-investor' : '.edit-transaction');
          if (editBtn) {
            if (idField === 'id') {
              editBtn.setAttribute('data-id', values['id'] ?? '');
              editBtn.setAttribute('data-name', values['name'] ?? '');
              editBtn.setAttribute('data-contact', values['contact'] ?? '');
            } else {
              editBtn.setAttribute('data-tid', values['tid'] ?? '');
              editBtn.setAttribute('data-stockid', values['stockId'] ?? '');
              editBtn.setAttribute('data-investorid', values['investorId'] ?? '');
              editBtn.setAttribute('data-amount', values['amount'] ?? '');
            }
          }
          break;
        }
      }
    }

    document.getElementById('investorEditForm')?.addEventListener('submit', (e) => handleEditSubmit(e, 'investorTableBody', 'id', ['id','name','contact']));
    document.getElementById('transactionEditForm')?.addEventListener('submit', (e) => handleEditSubmit(e, 'transactionTableBody', 'tid', ['tid','stockId','investorId','amount']));
  </script>

</body>
</html>
