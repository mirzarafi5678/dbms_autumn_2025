<%- include('../../partials/head') %>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen text-white">
  <%- include('../../partials/admin-nav') %>

  <div class="container mx-auto p-6 space-y-16">
    <!-- ================= STOCK TRANSACTIONS ================= -->
    <section>
      <h1 class="text-3xl font-bold mb-6 text-center">Stock Transactions Management</h1>

      <!-- Search + Add -->
      <div class="flex justify-between mb-4">
        <form method="GET" action="/Admin/transactions/search" class="flex gap-2">
          <input type="text" name="query" placeholder="Search by Transaction ID..." 
                 class="px-3 py-2 rounded-lg text-black" />
          <button type="submit" class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700">Search</button>
        </form>

        <button onclick="openAddTxModal()" class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700">
          Add Transaction
        </button>
      </div>

      <!-- Transactions Table -->
      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-700 rounded-lg">
          <thead class="bg-blue-800 text-white">
            <tr>
              <th class="px-4 py-2 border">Transaction ID</th>
              <th class="px-4 py-2 border">Stock ID</th>
              <th class="px-4 py-2 border">Investor ID</th>
              <th class="px-4 py-2 border">Amount</th>
              <th class="px-4 py-2 border">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (TransactionList && TransactionList.length > 0) { %>
              <% TransactionList.forEach(function(tx) { %>
                <tr class="border-b border-slate-700 hover:bg-slate-700">
                  <td class="py-2 px-4"><%= tx.transactionId %></td>
                  <td class="py-2 px-4"><%= tx.stockId %></td>
                  <td class="py-2 px-4"><%= tx.iUserId %></td>
                  <td class="py-2 px-4"><%= tx.amount %></td>
                  <td class="py-2 px-4 flex gap-2">
                    <button onclick='openEditTxModal(<%= JSON.stringify(tx) %>)'
                            class="bg-yellow-500 px-3 py-1 rounded-lg hover:bg-yellow-600">
                      Edit
                    </button>
                    <form action="/Admin/transactions/delete/<%= tx.transactionId %>" method="POST">
                      <button type="submit" class="bg-red-600 px-3 py-1 rounded-lg hover:bg-red-700">
                        Delete
                      </button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr><td colspan="5" class="text-center py-4">No transactions found</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </section>

    <!-- ================= INVESTORS ================= -->
    <section>
      <h1 class="text-3xl font-bold mb-6 text-center">Investor Management</h1>

      <!-- Search + Add -->
      <div class="flex justify-between mb-4">
        <form method="GET" action="/admin/investors/search" class="flex gap-2">
          <input type="text" name="query" placeholder="Search by Name or ID..." 
                 class="px-3 py-2 rounded-lg text-black" />
          <button type="submit" class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700">Search</button>
        </form>

        <button onclick="openAddInvestorModal()" class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700">
          Add Investor
        </button>
      </div>

      <!-- Investors Table -->
      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-700 rounded-lg">
          <thead class="bg-blue-800 text-white">
            <tr>
              <th class="px-4 py-2 border">Investor ID</th>
              <th class="px-4 py-2 border">Name</th>
              <th class="px-4 py-2 border">Account Type</th>
              <th class="px-4 py-2 border">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (InvestorList && InvestorList.length > 0) { %>
              <% InvestorList.forEach(function(investor) { %>
                <tr class="border-b border-slate-700 hover:bg-slate-700">
                  <td class="py-2 px-4"><%= investor.iUserId %></td>
                  <td class="py-2 px-4"><%= investor.name %></td>
                  <td class="py-2 px-4"><%= investor.accountType %></td>
                  <td class="py-2 px-4 flex gap-2">
                    <button onclick='openEditInvestorModal(<%= JSON.stringify(investor) %>)'
                            class="bg-yellow-500 px-3 py-1 rounded-lg hover:bg-yellow-600">
                      Edit
                    </button>
                    <form action="/Admin/investors/delete/<%= investor.iUserId %>" method="POST">
                      <button type="submit" class="bg-red-600 px-3 py-1 rounded-lg hover:bg-red-700">
                        Delete
                      </button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr><td colspan="4" class="text-center py-4">No investors found</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </section>

    <!-- ================= Logs ================= -->
    <section>
      <h1 class="text-3xl font-bold mb-6 text-center">LOGS</h1>

      <!-- Search + Add -->
      <div class="flex justify-between mb-4">
        <form method="GET" action="/Admin/logs/search" class="flex gap-2">
          <input type="text" name="query" placeholder="Search by User ID..." 
                 class="px-3 py-2 rounded-lg text-black" />
          <button type="submit" class="bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700">Search</button>
        </form>

        <button onclick="openAddLogModal()" class="bg-green-600 px-4 py-2 rounded-lg hover:bg-green-700">
          Add Log
        </button>
      </div>

      <!-- Stakeholders Table -->
      <div class="overflow-x-auto">
        <table class="min-w-full border border-gray-700 rounded-lg">
          <thead class="bg-blue-800 text-white">
            <tr>
              <th class="px-4 py-2 border">User ID</th>
              <th class="px-4 py-2 border">Login Time</th>
              <th class="px-4 py-2 border">Logout Time</th>
              <th class="px-4 py-2 border">Old User Data</th>
              <th class="px-4 py-2 border">New User Data</th>
              <th class="px-4 py-2 border">Auditor</th>
              <th class="px-4 py-2 border">Approval Status</th>
              <th class="px-4 py-2 border">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (LogsList && LogsList.length > 0) { %>
              <% LogsList.forEach(function(log) { %>
                <tr class="border-b border-slate-700 hover:bg-slate-700">
                  <td class="py-2 px-4"><%= log.userId %></td>
                  <td class="py-2 px-4"><%= log.loginTimestamp %></td>
                  <td class="py-2 px-4"><%= log.logoutTimestamp %></td>
                  <td class="py-2 px-4"><%= log.oldUserData %></td>
                  <td class="py-2 px-4"><%= log.newUserData %></td>
                  <td class="py-2 px-4"><%= log.auditorName %></td>
                  <td class="py-2 px-4"><%= log.tradeApprovalStatus %></td>
                  <td class="py-2 px-4 flex gap-2">
                    <button onclick='openEditLogModal(<%= JSON.stringify(log) %>)'
                            class="bg-yellow-500 px-3 py-1 rounded-lg hover:bg-yellow-600">
                      Edit
                    </button>
                    <form action="/Admin/logs/delete/<%= log.userId %>" method="POST">
                      <button type="submit" class="bg-red-600 px-3 py-1 rounded-lg hover:bg-red-700">
                        Delete
                      </button>
                    </form>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr><td colspan="8" class="text-center py-4">No logs found</td></tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- ================= TRANSACTION MODALS ================= -->
  <div id="addTxModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-slate-800 p-6 rounded-lg w-96">
      <h2 class="text-xl mb-4">Add Transaction</h2>
      <form method="POST" action="/Admin/transactions/add">
        <input type="datetime-local" name="timestamp" placeholder="Timestamp" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="stockId" placeholder="Stock ID" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="iUserId" placeholder="Investor ID" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="number" step="0.01" name="amount" placeholder="Amount" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="registrationNumber" placeholder="Company Registration Number" class="w-full p-2 mb-3 rounded text-black">
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeAddTxModal()" class="bg-gray-600 px-3 py-1 rounded-lg hover:bg-gray-700">Cancel</button>
          <button type="submit" class="bg-green-600 px-3 py-1 rounded-lg hover:bg-green-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="editTxModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-slate-800 p-6 rounded-lg w-96">
      <h2 class="text-xl mb-4">Edit Transaction</h2>
      <form id="editTxForm" method="POST">
        <input type="text" name="transactionId" id="editTransactionId" class="w-full p-2 mb-3 rounded text-black" readonly>
        <input type="datetime-local" name="timestamp" id="editTimestampTx" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="stockId" id="editStockIdTx" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="iUserId" id="editIUserIdTx" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="number" step="0.01" name="amount" id="editAmountTx" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="registrationNumber" id="editRegistrationNumberTx" class="w-full p-2 mb-3 rounded text-black">
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeEditTxModal()" class="bg-gray-600 px-3 py-1 rounded-lg hover:bg-gray-700">Cancel</button>
          <button type="submit" class="bg-yellow-500 px-3 py-1 rounded-lg hover:bg-yellow-600">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ================= INVESTOR MODALS ================= -->
  <div id="addInvestorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-slate-800 p-6 rounded-lg w-96">
      <h2 class="text-xl mb-4">Add Investor</h2>
      <form method="POST" action="/Admin/investors/add">
        <input type="text" name="name" placeholder="Name" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="accountType" placeholder="Account Type" class="w-full p-2 mb-3 rounded text-black" required>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeAddInvestorModal()" class="bg-gray-600 px-3 py-1 rounded-lg hover:bg-gray-700">Cancel</button>
          <button type="submit" class="bg-green-600 px-3 py-1 rounded-lg hover:bg-green-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="editInvestorModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-slate-800 p-6 rounded-lg w-96">
      <h2 class="text-xl mb-4">Edit Investor</h2>
      <form id="editInvestorForm" method="POST">
        <input type="text" name="iUserId" id="editIUserId" class="w-full p-2 mb-3 rounded text-black" readonly>
        <input type="text" name="name" id="editInvestorName" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="accountType" id="editInvestorAccountType" class="w-full p-2 mb-3 rounded text-black" required>
          <!-- ================= LOG MODALS ================= -->
          <div id="addLogModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
            <div class="bg-slate-800 p-6 rounded-lg w-96">
              <h2 class="text-xl mb-4">Add Log</h2>
              <form method="POST" action="/Admin/logs/add">
                <input type="text" name="userId" placeholder="User ID" class="w-full p-2 mb-3 rounded text-black" required>
                <input type="datetime-local" name="loginTimestamp" placeholder="Login Timestamp" class="w-full p-2 mb-3 rounded text-black">
                <input type="datetime-local" name="logoutTimestamp" placeholder="Logout Timestamp" class="w-full p-2 mb-3 rounded text-black">
                <textarea name="oldUserData" placeholder="Old User Data" class="w-full p-2 mb-3 rounded text-black"></textarea>
                <textarea name="newUserData" placeholder="New User Data" class="w-full p-2 mb-3 rounded text-black"></textarea>
                <input type="text" name="auditorName" placeholder="Auditor Name" class="w-full p-2 mb-3 rounded text-black">
                <input type="text" name="tradeApprovalStatus" placeholder="Approval Status" class="w-full p-2 mb-3 rounded text-black">
                <div class="flex justify-end gap-2">
                  <button type="button" onclick="closeAddLogModal()" class="bg-gray-600 px-3 py-1 rounded-lg hover:bg-gray-700">Cancel</button>
                  <button type="submit" class="bg-green-600 px-3 py-1 rounded-lg hover:bg-green-700">Save</button>
                </div>
              </form>
            </div>
          </div>

          <div id="editLogModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
            <div class="bg-slate-800 p-6 rounded-lg w-96">
              <h2 class="text-xl mb-4">Edit Log</h2>
              <form id="editLogForm" method="POST">
                <input type="text" name="userId" id="editLogUserId" class="w-full p-2 mb-3 rounded text-black" readonly>
                <input type="datetime-local" name="loginTimestamp" id="editLoginTimestamp" class="w-full p-2 mb-3 rounded text-black">
                <input type="datetime-local" name="logoutTimestamp" id="editLogoutTimestamp" class="w-full p-2 mb-3 rounded text-black">
                <textarea name="oldUserData" id="editOldUserData" class="w-full p-2 mb-3 rounded text-black"></textarea>
                <textarea name="newUserData" id="editNewUserData" class="w-full p-2 mb-3 rounded text-black"></textarea>
                <input type="text" name="auditorName" id="editAuditorName" class="w-full p-2 mb-3 rounded text-black">
                <input type="text" name="tradeApprovalStatus" id="editTradeApprovalStatus" class="w-full p-2 mb-3 rounded text-black">
                <div class="flex justify-end gap-2">
                  <button type="button" onclick="closeEditLogModal()" class="bg-gray-600 px-3 py-1 rounded-lg hover:bg-gray-700">Cancel</button>
                  <button type="submit" class="bg-yellow-500 px-3 py-1 rounded-lg hover:bg-yellow-600">Update</button>
                </div>
              </form>
            </div>
          </div>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeEditInvestorModal()" class="bg-gray-600 px-3 py-1 rounded-lg hover:bg-gray-700">Cancel</button>
          <button type="submit" class="bg-yellow-500 px-3 py-1 rounded-lg hover:bg-yellow-600">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ================= STAKEHOLDER MODALS ================= -->
  <div id="addStakeholderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-slate-800 p-6 rounded-lg w-96">
      <h2 class="text-xl mb-4">Add Stakeholder</h2>
      <form method="POST" action="/admin/stakeholders/add">
        <input type="text" name="name" placeholder="Name" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="email" name="email" placeholder="Email" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="tel" name="phoneNumber" placeholder="Phone Number" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="role" placeholder="Role" class="w-full p-2 mb-3 rounded text-black" required>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeAddStakeholderModal()" class="bg-gray-600 px-3 py-1 rounded-lg hover:bg-gray-700">Cancel</button>
          <button type="submit" class="bg-green-600 px-3 py-1 rounded-lg hover:bg-green-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <div id="editStakeholderModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center">
    <div class="bg-slate-800 p-6 rounded-lg w-96">
      <h2 class="text-xl mb-4">Edit Stakeholder</h2>
      <form id="editStakeholderForm" method="POST">
        <input type="text" name="name" id="editStakeholderName" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="email" name="email" id="editStakeholderEmail" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="tel" name="phoneNumber" id="editStakeholderPhone" class="w-full p-2 mb-3 rounded text-black" required>
        <input type="text" name="role" id="editStakeholderRole" class="w-full p-2 mb-3 rounded text-black" required>
        <div class="flex justify-end gap-2">
          <button type="button" onclick="closeEditStakeholderModal()" class="bg-gray-600 px-3 py-1 rounded-lg hover:bg-gray-700">Cancel</button>
          <button type="submit" class="bg-yellow-500 px-3 py-1 rounded-lg hover:bg-yellow-600">Update</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ================= SCRIPTS ================= -->
  <script>
    // Transaction Modals
    function openAddTxModal() { document.getElementById('addTxModal').classList.remove('hidden'); }
    function closeAddTxModal() { document.getElementById('addTxModal').classList.add('hidden'); }
    function openEditTxModal(tx) {
      document.getElementById('editTransactionId').value = tx.transactionId;
      document.getElementById('editTimestampTx').value = new Date(tx.timestamp).toISOString().slice(0,16);
      document.getElementById('editStockIdTx').value = tx.stockId;
      document.getElementById('editIUserIdTx').value = tx.iUserId;
      document.getElementById('editAmountTx').value = tx.amount;
      document.getElementById('editRegistrationNumberTx').value = tx.registrationNumber || '';
      document.getElementById('editTxForm').action = `/Admin/transactions/edit/${tx.transactionId}`;
      document.getElementById('editTxModal').classList.remove('hidden');
    }
    function closeEditTxModal() { document.getElementById('editTxModal').classList.add('hidden'); }

    // Investor Modals
    function openAddInvestorModal() { document.getElementById('addInvestorModal').classList.remove('hidden'); }
    function closeAddInvestorModal() { document.getElementById('addInvestorModal').classList.add('hidden'); }
    function openEditInvestorModal(investor) {
      document.getElementById('editIUserId').value = investor.iUserId;
      document.getElementById('editInvestorName').value = investor.name;
      document.getElementById('editInvestorAccountType').value = investor.accountType;
      document.getElementById('editInvestorForm').action = `/Admin/investors/edit/${investor.iUserId}`;
      document.getElementById('editInvestorModal').classList.remove('hidden');
    }
    function closeEditInvestorModal() { document.getElementById('editInvestorModal').classList.add('hidden'); }

    // Log modals
    function openAddLogModal() { document.getElementById('addLogModal').classList.remove('hidden'); }
    function closeAddLogModal() { document.getElementById('addLogModal').classList.add('hidden'); }
    function openEditLogModal(log) {
      document.getElementById('editLogUserId').value = log.userId;
      document.getElementById('editLoginTimestamp').value = new Date(log.loginTimestamp).toISOString().slice(0,16);
      document.getElementById('editLogoutTimestamp').value = log.logoutTimestamp ? new Date(log.logoutTimestamp).toISOString().slice(0,16) : '';
      document.getElementById('editOldUserData').value = log.oldUserData || '';
      document.getElementById('editNewUserData').value = log.newUserData || '';
      document.getElementById('editAuditorName').value = log.auditorName || '';
      document.getElementById('editTradeApprovalStatus').value = log.tradeApprovalStatus || '';
      document.getElementById('editLogForm').action = `/Admin/logs/edit/${log.userId}`;
      document.getElementById('editLogModal').classList.remove('hidden');
    }
    function closeEditLogModal() { document.getElementById('editLogModal').classList.add('hidden'); }

    // Stakeholder Modals
    function openAddStakeholderModal() { document.getElementById('addStakeholderModal').classList.remove('hidden'); }
    function closeAddStakeholderModal() { document.getElementById('addStakeholderModal').classList.add('hidden'); }
    function openEditStakeholderModal(stakeholder) {
      document.getElementById('editStakeholderName').value = stakeholder.name;
      document.getElementById('editStakeholderEmail').value = stakeholder.email;
      document.getElementById('editStakeholderPhone').value = stakeholder.phoneNumber;
      document.getElementById('editStakeholderRole').value = stakeholder.role;
      document.getElementById('editStakeholderForm').action = `/admin/stakeholders/edit/${stakeholder.id}`;
      document.getElementById('editStakeholderModal').classList.remove('hidden');
    }
    function closeEditStakeholderModal() { document.getElementById('editStakeholderModal').classList.add('hidden'); }
  </script>
</body>
</html>